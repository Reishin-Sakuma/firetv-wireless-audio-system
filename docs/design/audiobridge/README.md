# AudioBridge-Pi 技術設計文書

## 📋 文書概要

この設計文書群は、AudioBridge-Pi プロジェクトの要件定義書（`docs/reverse/audioBridge-requirements.md`）に基づいて生成された包括的な技術設計書です。実装済みシステムの逆エンジニアリング分析から抽出された要件を基に、将来の拡張・保守のための設計情報を体系化しています。

**生成日時**: 2025-08-21  
**対象システム**: AudioBridge-Pi (Raspberry Pi Zero 2W)  
**設計バージョン**: v1.0.0  
**要件カバレッジ**: 38要件（機能23・非機能15）

## 📚 文書構成

### 1. [アーキテクチャ設計](./architecture.md)
**システム全体のアーキテクチャパターンと技術スタック**

- **レイヤードアーキテクチャ**: 明確な責務分離による保守性向上
- **パイプライン処理**: リアルタイム音声データフローの最適化  
- **組み込みLinux統合**: systemd・Raspberry Pi OS最適化
- **堅牢性設計**: 自動復旧・エラーハンドリング機構

**主要技術**:
- Python 3.9+ / Flask (アプリケーション)
- BlueZ / PulseAudio / GStreamer (音声処理)
- hostapd / dnsmasq (WiFi AP)
- systemd (サービス管理)

### 2. [データフロー図](./dataflow.md)
**システム内のデータ流れと処理フローの可視化**

- **音声データパイプライン**: Bluetooth → PulseAudio → GStreamer → HTTP
- **システム状態遷移**: 初期化 → 接続待機 → 音声配信 → 復旧
- **ネットワーク通信フロー**: WiFi AP設定 → クライアント接続 → HTTPストリーミング
- **障害検知・復旧フロー**: 自動診断 → 復旧実行 → 状態監視

**Mermaid図表**:
- システム全体フロー図
- 音声処理パイプライン詳細
- ネットワーク通信シーケンス
- エラー処理・復旧フロー

### 3. [システムインターフェース](./interfaces.py)
**Python型ヒント・プロトコルによる設計契約定義**

- **データクラス**: 38の構造化データ型定義
- **プロトコル**: 5つの主要コンポーネント抽象化
- **列挙型**: システム状態・設定値の型安全性
- **検証関数**: 入力データの整合性チェック

**主要インターフェース**:
- `BluetoothManagerProtocol`: Bluetooth A2DP制御
- `AudioPipelineProtocol`: 音声処理パイプライン
- `WiFiManagerProtocol`: WiFi Access Point管理
- `HTTPStreamingProtocol`: HTTP音声配信

### 4. [設定スキーマ](./configuration-schema.yaml)
**YAML設定ファイルの完全な仕様定義**

- **包括的設定項目**: 7カテゴリ・100+設定パラメータ
- **バリデーション規則**: JSON Schema準拠の型・制約検証
- **設定例**: 本番・開発・高音質の3パターン実装例
- **ドキュメント**: 全設定項目の詳細説明・デフォルト値

**設定カテゴリ**:
- `system`: システム全体設定
- `bluetooth`: Bluetooth A2DP設定  
- `wifi`: WiFi Access Point設定
- `audio`: 音声品質・パイプライン設定
- `http`: HTTPサーバー設定
- `logging`: ログ出力設定
- `monitoring`: システム監視設定

### 5. [API エンドポイント](./api-endpoints.md)
**RESTful HTTP API の完全な仕様書**

- **音声ストリーミング**: `/audio.mp3` - Fire TV VLC対応
- **状態監視**: `/status`, `/health`, `/metrics` - システム監視
- **制御API**: `/control/*` - Bluetooth・音声・システム制御
- **設定管理**: `/config` - 動的設定変更
- **診断API**: `/debug` - トラブルシューティング支援

**API特徴**:
- RESTful設計原則準拠
- 統一的なJSON レスポンス形式
- 包括的エラーハンドリング
- セキュリティ・認証対応
- 外部システム統合支援

## 🎯 設計原則・品質特性

### アーキテクチャ原則
1. **モジュラリティ**: 疎結合・高凝集による保守性向上
2. **拡張性**: 新機能追加・既存機能変更の容易性  
3. **テスタビリティ**: 各層・コンポーネントの独立テスト可能性
4. **可観測性**: ログ・メトリクス・状態監視の充実

### 品質特性
- **信頼性**: 自動復旧・エラー処理による24時間稼働
- **パフォーマンス**: 200-400ms低遅延音声転送
- **セキュリティ**: WPA2暗号化・最小権限実行
- **ユーザビリティ**: ワンコマンド自動セットアップ

## 🔧 実装ガイドライン

### 開発原則
1. **型安全性**: `interfaces.py` の型定義厳守
2. **設定管理**: `configuration-schema.yaml` 準拠
3. **API設計**: `api-endpoints.md` 仕様実装
4. **エラーハンドリング**: 包括的な例外処理・ログ記録

### コード品質
- **Python PEP 8**: コードスタイル統一
- **型ヒント**: mypy 静的型チェック対応
- **ドキュメント**: docstring・型注釈の充実
- **テスト**: 単体・統合・システムテストの実装

### デプロイメント
- **自動化**: `scripts/setup.sh` ワンコマンドセットアップ  
- **サービス管理**: systemd 統合・自動起動
- **設定管理**: 環境別設定ファイル分離
- **監視**: ヘルスチェック・メトリクス収集

## 📊 要件トレーサビリティマトリクス

### 機能要件 → 設計要素マッピング

| 要件ID | 要件名 | アーキテクチャ | データフロー | インターフェース | API |
|--------|--------|--------------|------------|-------------|-----|
| REQ-001 | Bluetooth A2DP Sink | BlueZ統合層 | Bluetooth入力フロー | BluetoothManagerProtocol | /control/bluetooth/* |
| REQ-002 | WiFi Access Point | ネットワーク層 | WiFi AP設定フロー | WiFiManagerProtocol | /status (wifi) |
| REQ-003 | HTTP音声ストリーミング | プレゼンテーション層 | 音声出力フロー | HTTPStreamingProtocol | /audio.mp3 |
| REQ-004 | 自動デバイス認識 | アプリケーション層 | デバイス監視フロー | DeviceInfo型 | /control/bluetooth/devices |
| REQ-005 | システム統合制御 | メインアプリケーション | 統合制御フロー | AudioBridgeMainProtocol | /control/system/* |

### 非機能要件 → 設計実装マッピング

| NFR ID | 要件名 | 設計実装 | 測定方法 |
|--------|--------|---------|---------|
| NFR-001 | 音声遅延200-400ms | パイプライン最適化・バッファ調整 | /metrics API遅延測定 |
| NFR-002 | 128kbps以上音質 | GStreamer高品質エンコード | ビットレート動的制御 |
| NFR-101 | 30秒以内自動復旧 | 復旧制御機構・監視スレッド | 復旧履歴API記録 |
| NFR-201 | WPA2暗号化 | hostapd強制暗号化設定 | セキュリティ設定検証 |

## 🚀 将来拡張ロードマップ

### Phase 2: 管理・監視機能強化
- **Web管理UI**: ブラウザベース設定・監視インターフェース
- **MQTT統合**: IoT プラットフォーム連携
- **より高度な音質コーデック**: aptX・LDAC対応

### Phase 3: 高可用性・スケーラビリティ
- **マルチインスタンス**: 複数Raspberry Pi統合
- **負荷分散**: クライアント負荷の自動分散  
- **クラウド統合**: AWS IoT・Azure IoT対応

### Phase 4: エンタープライズ機能
- **ユーザー認証**: 多要素認証・権限管理
- **監査ログ**: セキュリティ・コンプライアンス対応
- **API管理**: レート制限・API Key管理

## 🔍 設計検証・承認事項

### アーキテクチャ決定記録 (ADR)

#### ADR-001: レイヤードアーキテクチャ採用
- **決定**: 4層アーキテクチャによる責務分離
- **理由**: 保守性・テスタビリティ・拡張性の向上
- **代替案**: モノリシック・マイクロサービス
- **結果**: 明確なモジュール境界・独立テスト実現

#### ADR-002: Python + Flask採用  
- **決定**: Pythonエコシステム・Flaskマイクロフレームワーク
- **理由**: Raspberry Pi最適化・豊富なライブラリ・開発効率
- **代替案**: Go・Node.js・C++
- **結果**: 高い開発生産性・ライブラリ活用

#### ADR-003: systemd統合
- **決定**: systemd ネイティブサービス統合
- **理由**: Raspberry Pi OS標準・堅牢なプロセス管理
- **代替案**: Docker・独自デーモン化  
- **結果**: OS統合・自動起動・プロセス監視実現

### 品質保証チェックリスト

#### 設計品質
- ✅ **要件カバレッジ**: 全38要件の設計要素マッピング完了
- ✅ **一貫性**: 全文書間の整合性確保・相互参照整備
- ✅ **完全性**: アーキテクチャ・データフロー・API・設定の包括カバー
- ✅ **実装可能性**: 既存実装との整合性・技術的実現性確認

#### 文書品質  
- ✅ **可読性**: 技術者が理解できる明確な記述
- ✅ **保守性**: 将来の更新・拡張に対応可能な構造
- ✅ **検索性**: 目的の情報に迅速にアクセス可能
- ✅ **バージョン管理**: 設計変更の追跡可能性

## 📞 サポート・問い合わせ

### 設計文書に関する質問
このドキュメントに関する質問・改善提案は、以下の方法でお寄せください：

1. **GitHub Issues**: プロジェクトリポジトリでのIssue作成
2. **Pull Request**: 設計改善・修正のプルリクエスト  
3. **アーキテクチャレビュー**: 設計判断に関する議論

### 関連リポジトリ・リソース
- **AudioBridge-Pi メインリポジトリ**: [GitHub]
- **要件定義書**: `docs/reverse/audioBridge-requirements.md`
- **実装コードベース**: `audio_bridge/`、`scripts/`、`config/`

---

**設計文書生成完了日**: 2025-08-21  
**次回レビュー予定**: プロジェクト Phase 2 計画時
**メンテナンス責任**: プロジェクト開発チーム